<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu·∫£n L√Ω M√°y V7.2 (Refresh)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        :root { --main-color: #1a237e; }
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        .form-section { background: white; padding: 12px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        /* Style cho label v√† n√∫t refresh */
        .form-label-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .form-label { font-size: 13px; font-weight: 600; color: #555; }
        .btn-refresh { color: var(--main-color); cursor: pointer; padding: 4px; font-size: 14px; transition: transform 0.3s; }
        .btn-refresh:hover { transform: rotate(30deg); color: #303f9f; }
        
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; }
        .btn-submit { background-color: var(--main-color); color: white; width: 100%; padding: 14px; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 10px; }
        
        .work-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .work-table th { background: var(--main-color); color: white; padding: 8px 4px; font-size: 12px; text-align: left; }
        .work-table th:first-child { border-top-left-radius: 8px; }
        .work-table th:last-child { border-top-right-radius: 8px; }
        .work-table td { border-bottom: 1px solid #eee; padding: 6px 2px; }
        .row-input { width: 100%; padding: 6px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; }
        .total-badge { background: #e0e7ff; color: #1a237e; padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 13px; display: inline-block; }
        
        #qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        #qr-reader { width: 320px; background: white; padding: 10px; border-radius: 8px; }
        .btn-close-qr { margin-top: 20px; color: white; border: 1px solid white; padding: 8px 20px; border-radius: 20px; }
    </style>
</head>
<body>

    <div class="bg-[#1a237e] text-white p-4 sticky top-0 z-50 shadow-lg text-center flex justify-between items-center">
        <div class="font-bold uppercase text-lg"><i class="fas fa-sync-alt mr-2"></i>Nh·∫≠t Tr√¨nh V7.2</div>
    </div>

    <div id="qr-modal">
        <div id="qr-reader"></div>
        <button class="btn-close-qr" onclick="stopScan()">ƒê√≥ng Camera</button>
    </div>

    <div class="container mx-auto p-3 pb-24 max-w-lg">
        <form id="reportForm" onsubmit="submitForm(event)">
            
            <div class="form-section">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="form-label">Ng√†y b√°o c√°o</label>
                        <input type="date" id="ngayBaoCao" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">SƒêT L√°i m√°y</label>
                        <input type="tel" id="sdt" class="form-input" placeholder="09xxxx..." required>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-label-group text-blue-800">
                        <label class="form-label"><i class="fas fa-building mr-1"></i> T√™n C√¥ng Tr√¨nh</label>
                        <i class="fas fa-sync-alt btn-refresh" onclick="refreshAllData(this)" title="C·∫≠p nh·∫≠t danh s√°ch"></i>
                    </div>
                    <select id="tenCongTrinh" class="form-input bg-yellow-50 font-semibold" required>
                        <option value="">-- ƒêang t·∫£i danh s√°ch... --</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <div class="form-label-group">
                        <label class="form-label">Ch·ªçn thi·∫øt b·ªã</label>
                        <i class="fas fa-sync-alt btn-refresh" onclick="refreshAllData(this)" title="C·∫≠p nh·∫≠t danh s√°ch m√°y"></i>
                    </div>
                    <div class="flex gap-2">
                        <select id="maThietBi" class="form-input bg-blue-50 flex-1" required>
                            <option value="">-- ƒêang t·∫£i m√°y... --</option>
                        </select>
                        <button type="button" onclick="startScan()" class="bg-[#1a237e] text-white px-4 rounded-lg shadow"><i class="fas fa-qrcode"></i></button>
                    </div>
                </div>

                <div>
                    <label class="form-label">Ng∆∞·ªùi b√°o c√°o</label>
                    <input type="text" id="nguoiBao" class="form-input" placeholder="H·ªç t√™n..." required>
                </div>
            </div>

            <div class="form-section p-0 overflow-hidden">
                <div class="bg-gray-50 p-3 flex justify-between items-center border-b">
                    <span class="font-bold text-[#1a237e] text-sm">Chi ti·∫øt c√¥ng vi·ªác</span>
                    <button type="button" onclick="addWorkRow()" class="text-xs bg-white border border-blue-900 text-blue-900 px-3 py-1 rounded-full font-bold">+ Th√™m d√≤ng</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="work-table">
                        <thead>
                            <tr>
                                <th style="width: 22%">Ca</th>
                                <th style="width: 38%">N·ªôi dung</th>
                                <th style="width: 15%">SL</th>
                                <th style="width: 20%">ƒêVT</th>
                                <th style="width: 5%"></th>
                            </tr>
                        </thead>
                        <tbody id="workTableBody"></tbody>
                    </table>
                </div>
                <div class="p-3 bg-gray-50 border-t text-right">
                    <span class="text-xs text-gray-500 mr-2">T·ªïng:</span>
                    <span id="displayTotal" class="total-badge">0</span>
                </div>
            </div>

            <div class="form-section p-0 overflow-hidden">
                <div class="bg-gray-50 p-3 flex justify-between items-center border-b">
                    <span class="font-bold text-[#1a237e] text-sm">Nhi√™n li·ªáu & D·∫ßu m·ª°</span>
                    <button type="button" onclick="addFuelRow()" class="text-xs bg-white border border-blue-900 text-blue-900 px-3 py-1 rounded-full font-bold">+ Th√™m d√≤ng</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="work-table">
                        <thead>
                            <tr>
                                <th style="width: 45%">Lo·∫°i</th>
                                <th style="width: 25%">ƒêVT</th>
                                <th style="width: 25%">SL</th>
                                <th style="width: 5%"></th>
                            </tr>
                        </thead>
                        <tbody id="fuelTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="form-section border-l-4 border-red-500 bg-red-50">
                <label class="form-label text-red-700 mb-2">S·ª≠a ch·ªØa & Ki·∫øn ngh·ªã</label>
                <textarea id="noiDungSua" class="form-input mb-2" rows="1" placeholder="H·ªèng h√≥c..."></textarea>
                <input type="number" id="chiPhiSua" class="form-input mb-2" placeholder="Chi ph√≠ (VNƒê)">
                <textarea id="kienNghi" class="form-input bg-yellow-50" rows="1" placeholder="ƒê·ªÅ xu·∫•t..."></textarea>
            </div>

            <button type="submit" class="btn-submit"><i class="fas fa-paper-plane mr-2"></i> G·ª¨I B√ÅO C√ÅO</button>
        </form>
    </div>

    <datalist id="unitOptions"><option value="L√≠t"><option value="Kg"><option value="H·ªôp"><option value="C√°i"></datalist>

    <script>
        // üëâ ANH D√ÅN LINK API C·ª¶A ANH V√ÄO ƒê√ÇY:
        const API_URL = "https://script.google.com/macros/s/AKfycbyl5PcdJUh7GjoX0m-SzADXDyX3wOXVRcrz6gkA2H_uCZ9XjnOPQ1lSf1eXd3JUxhGo/exec";

        let html5QrcodeScanner = null;
        // C·∫•u h√¨nh Toast th√¥ng b√°o nh·ªè g√≥c m√†n h√¨nh
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true,
            didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
        });

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById('ngayBaoCao').valueAsDate = new Date();
            // T·∫£i d·ªØ li·ªáu l·∫ßn ƒë·∫ßu
            Promise.all([fetchProjects(), fetchMachines()]);
            addWorkRow(); addFuelRow();
        });

        // --- CH·ª®C NƒÇNG L√ÄM M·ªöI D·ªÆ LI·ªÜU (M·ªöI) ---
        async function refreshAllData(btnElement) {
            // Hi·ªáu ·ª©ng quay icon
            if(btnElement) btnElement.classList.add('fa-spin');
            
            // Hi·ªán th√¥ng b√°o ƒëang t·∫£i
            Toast.fire({ icon: 'info', title: 'ƒêang l√†m m·ªõi d·ªØ li·ªáu...' });

            // G·ªçi ƒë·ªìng th·ªùi c·∫£ 2 h√†m t·∫£i
            await Promise.all([fetchProjects(), fetchMachines()]);

            // T·∫Øt hi·ªáu ·ª©ng quay v√† b√°o th√†nh c√¥ng
            if(btnElement) btnElement.classList.remove('fa-spin');
            Toast.fire({ icon: 'success', title: 'ƒê√£ c·∫≠p nh·∫≠t xong!' });
        }

        // --- C√ÅC H√ÄM T·∫¢I D·ªÆ LI·ªÜU (ƒê√£ tinh ch·ªânh ƒë·ªÉ d√πng chung) ---
        async function fetchProjects() {
            const sel = document.getElementById('tenCongTrinh');
            sel.innerHTML = '<option value="">ƒêang t·∫£i...</option>';
            try {
                const res = await fetch(API_URL + "?action=getDanhSachCongTrinh");
                const data = await res.json();
                if (!Array.isArray(data) || data.length === 0 || (data[0] && data[0].includes("Ch∆∞a t·∫°o"))) {
                    sel.innerHTML = '<option value="">-- Sheet c√¥ng tr√¨nh tr·ªëng --</option>'; return;
                }
                sel.innerHTML = '<option value="">-- Ch·ªçn c√¥ng tr√¨nh --</option>';
                data.forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);
            } catch (e) { sel.innerHTML = '<option>‚ö†Ô∏è L·ªói k·∫øt n·ªëi</option>'; }
        }

        async function fetchMachines() {
            const sel = document.getElementById('maThietBi');
            sel.innerHTML = '<option value="">ƒêang t·∫£i...</option>';
            try {
                const res = await fetch(API_URL + "?action=getDanhSachMay");
                const machines = await res.json();
                sel.innerHTML = '<option value="">-- Ch·ªçn m√°y --</option>';
                machines.forEach(m => sel.innerHTML += `<option value="${m.maMay}">${m.tenMay} (${m.bienSo})</option>`);
            } catch (e) { sel.innerHTML = '<option>‚ö†Ô∏è L·ªói t·∫£i m√°y</option>'; }
        }

        // --- QR CODE & C√ÅC H√ÄM KH√ÅC (GI·ªÆ NGUY√äN) ---
        function startScan() {
            document.getElementById('qr-modal').style.display = 'flex';
            if (html5QrcodeScanner === null) html5QrcodeScanner = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrcodeScanner.start({ facingMode: "environment" }, config, (decodedText) => {
                stopScan();
                const select = document.getElementById('maThietBi');
                let found = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === decodedText) { select.selectedIndex = i; found = true; break; }
                }
                if(found) Toast.fire({ icon: 'success', title: 'ƒê√£ ch·ªçn m√°y: ' + decodedText });
                else Swal.fire('Kh√¥ng t√¨m th·∫•y', 'M√£ QR: ' + decodedText + ' kh√¥ng c√≥ trong danh s√°ch', 'warning');
            }, () => {}).catch(err => { Swal.fire('L·ªói', 'Vui l√≤ng c·∫•p quy·ªÅn Camera', 'error'); stopScan(); });
        }
        function stopScan() {
            if (html5QrcodeScanner) html5QrcodeScanner.stop().then(() => document.getElementById('qr-modal').style.display = 'none').catch(() => document.getElementById('qr-modal').style.display = 'none');
            else document.getElementById('qr-modal').style.display = 'none';
        }

        function addWorkRow() {
            const tbody = document.getElementById('workTableBody');
            const rowId = 'w-' + Date.now();
            const tr = document.createElement('tr');
            tr.id = rowId;
            tr.innerHTML = `
                <td><select class="row-input w-shift font-bold text-blue-800"><option>S√°ng</option><option>Chi·ªÅu</option><option>TƒÉng ca</option></select></td>
                <td><input type="text" class="row-input w-content" placeholder="Vi·ªác..."></td>
                <td><input type="number" class="row-input w-vol text-center font-bold" placeholder="0" step="0.5" oninput="calcTotal()"></td>
                <td><select class="row-input w-unit text-xs" onchange="calcTotal()"><option>Gi·ªù</option><option>Chuy·∫øn</option><option>m3</option><option>Ca</option><option>km</option></select></td>
                <td class="text-center"><i class="fas fa-times text-red-500 cursor-pointer p-1" onclick="removeRow('${rowId}', true)"></i></td>
            `;
            tbody.appendChild(tr);
        }
        function addFuelRow() {
            const tbody = document.getElementById('fuelTableBody');
            const rowId = 'f-' + Date.now();
            const tr = document.createElement('tr');
            tr.id = rowId;
            tr.innerHTML = `
                <td><select class="row-input f-type font-semibold"><option>Diesel</option><option>D·∫ßu c·∫ßu</option><option>D·∫ßu th·ªßy l·ª±c</option><option>D·∫ßu m√°y</option><option>M·ª°</option><option>N∆∞·ªõc l√†m m√°t</option><option>Kh√°c</option></select></td>
                <td><input list="unitOptions" class="row-input f-unit text-center" value="L√≠t"></td>
                <td><input type="number" class="row-input f-vol text-center font-bold" placeholder="0" step="0.1"></td>
                <td class="text-center"><i class="fas fa-times text-red-500 cursor-pointer p-1" onclick="removeRow('${rowId}', false)"></i></td>
            `;
            tbody.appendChild(tr);
        }
        function removeRow(id, isWork) {
            const row = document.getElementById(id);
            if (row.parentNode.children.length > 1) { row.remove(); if(isWork) calcTotal(); }
            else { row.querySelectorAll('input').forEach(i => i.value = ''); }
        }
        function calcTotal() {
            let totals = {};
            document.querySelectorAll('#workTableBody tr').forEach(row => {
                const vol = parseFloat(row.querySelector('.w-vol').value) || 0;
                const unit = row.querySelector('.w-unit').value;
                if (vol > 0) totals[unit] = (totals[unit] || 0) + vol;
            });
            document.getElementById('displayTotal').innerText = Object.entries(totals).map(([u, v]) => `${v} ${u}`).join(" + ") || "0";
        }

        function submitForm(e) {
            e.preventDefault();
            Swal.fire({ title: 'ƒêang g·ª≠i...', didOpen: () => Swal.showLoading() });
            let works = [], fuelData = { diesel: 0, dauCau: 0, thuyLuc: 0, dauMay: 0, khac: [] };
            document.querySelectorAll('#workTableBody tr').forEach(row => {
                const c = row.querySelector('.w-content').value;
                const v = row.querySelector('.w-vol').value;
                if(c || v) works.push({ caLam: row.querySelector('.w-shift').value, noiDung: c || "Kh√¥ng ghi", khoiLuong: v || 0, donVi: row.querySelector('.w-unit').value });
            });
            document.querySelectorAll('#fuelTableBody tr').forEach(row => {
                const t = row.querySelector('.f-type').value;
                const v = parseFloat(row.querySelector('.f-vol').value) || 0;
                const u = row.querySelector('.f-unit').value;
                if(v > 0) { if(t=='Diesel') fuelData.diesel += v; else if(t=='D·∫ßu c·∫ßu') fuelData.dauCau += v; else if(t=='D·∫ßu th·ªßy l·ª±c') fuelData.thuyLuc += v; else if(t=='D·∫ßu m√°y') fuelData.dauMay += v; else fuelData.khac.push(`${t}: ${v}${u}`); }
            });
            const data = {
                ngayBaoCao: document.getElementById('ngayBaoCao').value, tenCongTrinh: document.getElementById('tenCongTrinh').value, sdt: document.getElementById('sdt').value, maThietBi: document.getElementById('maThietBi').value, nguoiBao: document.getElementById('nguoiBao').value,
                danhSachViec: works, tongKhoiLuong: document.getElementById('displayTotal').innerText, diesel: fuelData.diesel, dauCau: fuelData.dauCau, dauThuyLuc: fuelData.thuyLuc, dauMay: fuelData.dauMay, dauKhac: fuelData.khac.join(", "),
                noiDungSua: document.getElementById('noiDungSua').value, chiPhiSua: document.getElementById('chiPhiSua').value, kienNghi: document.getElementById('kienNghi').value
            };
            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(data) })
            .then(() => {
                Swal.fire({ icon: 'success', title: 'Th√†nh c√¥ng!', timer: 1500, showConfirmButton: false });
                document.getElementById('reportForm').reset(); document.getElementById('workTableBody').innerHTML = ''; addWorkRow(); document.getElementById('fuelTableBody').innerHTML = ''; addFuelRow(); document.getElementById('displayTotal').innerText = "0"; document.getElementById('ngayBaoCao').valueAsDate = new Date();
                refreshAllData(); // T·ª± ƒë·ªông l√†m m·ªõi sau khi g·ª≠i
            }).catch(e => Swal.fire('L·ªói', e.toString(), 'error'));
        }
    </script>
</body>
</html>
