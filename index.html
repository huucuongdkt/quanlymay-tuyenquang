<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu·∫£n L√Ω M√°y V7.3 Final</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        :root { --main-color: #1a237e; } /* M√†u T√≠m than ch·ªß ƒë·∫°o */
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .form-section { background: white; padding: 12px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* Label v√† N√∫t Refresh */
        .form-label-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .form-label { font-size: 13px; font-weight: 600; color: #555; }
        .btn-refresh { color: var(--main-color); cursor: pointer; padding: 4px; font-size: 14px; transition: transform 0.5s; }
        .btn-refresh:hover { transform: rotate(180deg); color: #303f9f; }
        
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; }
        .form-input:focus { border-color: var(--main-color); outline: none; box-shadow: 0 0 0 2px rgba(26,35,126,0.1); }
        
        .btn-submit { background-color: var(--main-color); color: white; width: 100%; padding: 14px; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn-submit:active { transform: scale(0.98); }
        
        /* B·∫£ng d·ªØ li·ªáu */
        .work-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .work-table th { background: var(--main-color); color: white; padding: 8px 4px; font-size: 12px; text-align: left; }
        .work-table th:first-child { border-top-left-radius: 8px; }
        .work-table th:last-child { border-top-right-radius: 8px; }
        .work-table td { border-bottom: 1px solid #eee; padding: 6px 2px; vertical-align: middle; }
        
        .row-input { width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; background: #fff; }
        .total-badge { background: #e0e7ff; color: #1a237e; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 13px; display: inline-block; border: 1px solid #c7d2fe; }
        
        /* Modal Camera QR */
        #qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        #qr-reader { width: 320px; background: white; padding: 10px; border-radius: 8px; }
        .btn-close-qr { margin-top: 20px; color: white; border: 1px solid white; padding: 8px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

    <div class="bg-[#1a237e] text-white p-4 sticky top-0 z-50 shadow-lg text-center flex justify-between items-center">
        <div class="font-bold uppercase text-lg"><i class="fas fa-check-double mr-2"></i>Nh·∫≠t Tr√¨nh V7.3</div>
    </div>

    <div id="qr-modal">
        <div id="qr-reader"></div>
        <button class="btn-close-qr" onclick="stopScan()"><i class="fas fa-times mr-2"></i>ƒê√≥ng Camera</button>
    </div>

    <div class="container mx-auto p-3 pb-24 max-w-lg">
        <form id="reportForm" onsubmit="submitForm(event)">
            
            <div class="form-section">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="form-label">Ng√†y b√°o c√°o</label>
                        <input type="date" id="ngayBaoCao" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">SƒêT L√°i m√°y</label>
                        <input type="tel" id="sdt" class="form-input" placeholder="09xxxx..." required>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-label-group text-blue-800">
                        <label class="form-label"><i class="fas fa-building mr-1"></i> T√™n C√¥ng Tr√¨nh</label>
                        <i class="fas fa-sync-alt btn-refresh" onclick="refreshAllData(this)" title="C·∫≠p nh·∫≠t danh s√°ch"></i>
                    </div>
                    <select id="tenCongTrinh" class="form-input bg-yellow-50 font-semibold text-blue-900" required>
                        <option value="">-- ƒêang t·∫£i danh s√°ch... --</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <div class="form-label-group">
                        <label class="form-label">Ch·ªçn thi·∫øt b·ªã</label>
                        <i class="fas fa-sync-alt btn-refresh" onclick="refreshAllData(this)" title="C·∫≠p nh·∫≠t m√°y"></i>
                    </div>
                    <div class="flex gap-2">
                        <select id="maThietBi" class="form-input bg-blue-50 flex-1" required>
                            <option value="">-- ƒêang t·∫£i m√°y... --</option>
                        </select>
                        <button type="button" onclick="startScan()" class="bg-[#1a237e] text-white px-4 rounded-lg shadow hover:bg-blue-800 transition">
                            <i class="fas fa-qrcode text-xl"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="form-label">Ng∆∞·ªùi b√°o c√°o</label>
                    <input type="text" id="nguoiBao" class="form-input" placeholder="Nh·∫≠p h·ªç t√™n..." required>
                </div>
            </div>

            <div class="form-section p-0 overflow-hidden">
                <div class="bg-gray-50 p-3 flex justify-between items-center border-b">
                    <span class="font-bold text-[#1a237e] text-sm"><i class="fas fa-list-ul mr-1"></i> Chi ti·∫øt c√¥ng vi·ªác</span>
                    <button type="button" onclick="addWorkRow()" class="text-xs bg-white border border-blue-900 text-blue-900 px-3 py-1.5 rounded-full font-bold shadow-sm hover:bg-blue-50">
                        <i class="fas fa-plus"></i> Th√™m d√≤ng
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="work-table">
                        <thead>
                            <tr>
                                <th style="width: 22%">Ca</th>
                                <th style="width: 38%">N·ªôi dung</th>
                                <th style="width: 15%">SL</th>
                                <th style="width: 20%">ƒêVT</th>
                                <th style="width: 5%"></th>
                            </tr>
                        </thead>
                        <tbody id="workTableBody">
                            </tbody>
                    </table>
                </div>
                <div class="p-3 bg-gray-50 border-t text-right">
                    <span class="text-xs text-gray-500 mr-2">T·ªïng c·ªông:</span>
                    <span id="displayTotal" class="total-badge">0</span>
                </div>
            </div>

            <div class="form-section p-0 overflow-hidden">
                <div class="bg-gray-50 p-3 flex justify-between items-center border-b">
                    <span class="font-bold text-[#1a237e] text-sm"><i class="fas fa-gas-pump mr-1"></i> Nhi√™n li·ªáu & D·∫ßu m·ª°</span>
                    <button type="button" onclick="addFuelRow()" class="text-xs bg-white border border-blue-900 text-blue-900 px-3 py-1.5 rounded-full font-bold shadow-sm hover:bg-blue-50">
                        <i class="fas fa-plus"></i> Th√™m d√≤ng
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="work-table">
                        <thead>
                            <tr>
                                <th style="width: 45%">Lo·∫°i</th>
                                <th style="width: 25%">ƒêVT</th>
                                <th style="width: 25%">SL</th>
                                <th style="width: 5%"></th>
                            </tr>
                        </thead>
                        <tbody id="fuelTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="form-section border-l-4 border-red-500 bg-red-50">
                <label class="form-label text-red-700 mb-2"><i class="fas fa-tools mr-1"></i> S·ª≠a ch·ªØa & Ki·∫øn ngh·ªã</label>
                <textarea id="noiDungSua" class="form-input mb-2" rows="1" placeholder="N·ªôi dung h·ªèng h√≥c..."></textarea>
                <input type="number" id="chiPhiSua" class="form-input mb-2" placeholder="Chi ph√≠ d·ª± ki·∫øn (VNƒê)">
                <textarea id="kienNghi" class="form-input bg-yellow-50 border-yellow-200" rows="1" placeholder="ƒê·ªÅ xu·∫•t v·∫≠t t∆∞/kh√°c..."></textarea>
            </div>

            <button type="submit" class="btn-submit">
                <i class="fas fa-paper-plane mr-2"></i> G·ª¨I B√ÅO C√ÅO NGAY
            </button>
            <div class="text-center text-xs text-gray-400 mt-4 pb-4">System V7.3 Final by Gemini</div>
        </form>
    </div>

    <datalist id="unitOptions">
        <option value="L√≠t"><option value="Kg"><option value="H·ªôp"><option value="C√°i">
    </datalist>

    <script>
        // ============================================================
        // üëâ LINK API M·ªöI NH·∫§T C·ª¶A ANH ƒê√É ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T ·ªû ƒê√ÇY:
        const API_URL = "https://script.google.com/macros/s/AKfycbyl5PcdJUh7GjoX0m-SzADXDyX3wOXVRcrz6gkA2H_uCZ9XjnOPQ1lSf1eXd3JUxhGo/exec";
        // ============================================================

        let html5QrcodeScanner = null;
        
        // C·∫•u h√¨nh Toast th√¥ng b√°o
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true,
            didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
        });

        // KHI TRANG WEB T·∫¢I XONG
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById('ngayBaoCao').valueAsDate = new Date();
            // T·∫£i d·ªØ li·ªáu ban ƒë·∫ßu
            Promise.all([fetchProjects(), fetchMachines()]);
            addWorkRow(); // Th√™m d√≤ng vi·ªác m·∫∑c ƒë·ªãnh
            addFuelRow(); // Th√™m d√≤ng d·∫ßu m·∫∑c ƒë·ªãnh
        });

        // --- 1. CH·ª®C NƒÇNG L√ÄM M·ªöI (REFRESH) ---
        async function refreshAllData(btnElement) {
            if(btnElement) btnElement.classList.add('fa-spin');
            Toast.fire({ icon: 'info', title: 'ƒêang c·∫≠p nh·∫≠t d·ªØ li·ªáu...' });
            await Promise.all([fetchProjects(), fetchMachines()]);
            if(btnElement) btnElement.classList.remove('fa-spin');
            Toast.fire({ icon: 'success', title: 'ƒê√£ c·∫≠p nh·∫≠t xong!' });
        }

        // --- 2. C√ÅC H√ÄM T·∫¢I D·ªÆ LI·ªÜU T·ª™ SHEET ---
        async function fetchProjects() {
            const sel = document.getElementById('tenCongTrinh');
            sel.innerHTML = '<option value="">ƒêang t·∫£i...</option>';
            try {
                const res = await fetch(API_URL + "?action=getDanhSachCongTrinh");
                const data = await res.json();
                
                if (!Array.isArray(data) || data.length === 0 || (data[0] && data[0].includes("Ch∆∞a t·∫°o"))) {
                    sel.innerHTML = '<option value="">-- Sheet c√¥ng tr√¨nh tr·ªëng --</option>'; 
                    return;
                }
                sel.innerHTML = '<option value="">-- Ch·ªçn c√¥ng tr√¨nh --</option>';
                data.forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);
            } catch (e) { 
                console.error(e);
                sel.innerHTML = '<option>‚ö†Ô∏è L·ªói k·∫øt n·ªëi Server</option>'; 
            }
        }

        async function fetchMachines() {
            const sel = document.getElementById('maThietBi');
            sel.innerHTML = '<option value="">ƒêang t·∫£i...</option>';
            try {
                const res = await fetch(API_URL + "?action=getDanhSachMay");
                const machines = await res.json();
                sel.innerHTML = '<option value="">-- Ch·ªçn m√°y --</option>';
                machines.forEach(m => sel.innerHTML += `<option value="${m.maMay}">${m.tenMay} (${m.bienSo})</option>`);
            } catch (e) { 
                sel.innerHTML = '<option>‚ö†Ô∏è L·ªói t·∫£i m√°y</option>'; 
            }
        }

        // --- 3. QR CODE SCANNER ---
        function startScan() {
            document.getElementById('qr-modal').style.display = 'flex';
            if (html5QrcodeScanner === null) html5QrcodeScanner = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrcodeScanner.start({ facingMode: "environment" }, config, (decodedText) => {
                stopScan();
                const select = document.getElementById('maThietBi');
                let found = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === decodedText) { select.selectedIndex = i; found = true; break; }
                }
                if(found) Toast.fire({ icon: 'success', title: 'ƒê√£ ch·ªçn: ' + decodedText });
                else Swal.fire('L·ªói', 'M√£ QR: ' + decodedText + ' kh√¥ng c√≥ trong danh s√°ch', 'warning');
            }, () => {}).catch(err => { 
                Swal.fire('L·ªói Camera', 'Vui l√≤ng c·∫•p quy·ªÅn Camera cho tr√¨nh duy·ªát', 'error'); 
                stopScan(); 
            });
        }
        function stopScan() {
            if (html5QrcodeScanner) html5QrcodeScanner.stop().then(() => document.getElementById('qr-modal').style.display = 'none').catch(() => document.getElementById('qr-modal').style.display = 'none');
            else document.getElementById('qr-modal').style.display = 'none';
        }

        // --- 4. X·ª¨ L√ù B·∫¢NG C√îNG VI·ªÜC ---
