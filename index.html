<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω V8.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        :root { --main-color: #1a237e; }
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* M√†n h√¨nh ƒëƒÉng nh·∫≠p */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a237e; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        /* Tab Navigation Bottom */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { text-align: center; color: #999; font-size: 12px; cursor: pointer; }
        .nav-item.active { color: var(--main-color); font-weight: bold; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 3px; }

        /* C√°c m√†n h√¨nh */
        .screen { display: none; padding-bottom: 80px; } /* ƒê·ªÉ ch·ª´a ch·ªó cho thanh menu d∆∞·ªõi */
        .screen.active { display: block; }

        /* Style Form & Card */
        .form-section { background: white; padding: 12px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; margin-bottom: 10px; }
        .btn-submit { background-color: var(--main-color); color: white; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; margin-top: 5px; }
        
        /* Style cho ph·∫ßn T·ªïng qu√°t */
        .stat-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--main-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-value { font-size: 24px; font-weight: bold; color: var(--main-color); }
        .history-item { border-bottom: 1px solid #eee; padding: 8px 0; font-size: 13px; }
        .history-date { color: #666; font-size: 11px; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 class="text-2xl font-bold text-blue-900 mb-4">ƒêƒÇNG NH·∫¨P</h2>
            <input type="text" id="username" class="form-input" placeholder="S·ªë ƒëi·ªán tho·∫°i / T√†i kho·∫£n">
            <input type="password" id="password" class="form-input" placeholder="M·∫≠t kh·∫©u">
            <button onclick="doLogin()" class="btn-submit w-full">V√ÄO H·ªÜ TH·ªêNG</button>
        </div>
        <p class="text-white text-xs mt-4">H·ªá th·ªëng qu·∫£n l√Ω m√°y V8.0</p>
    </div>

    <div class="bg-[#1a237e] text-white p-4 sticky top-0 z-50 shadow text-center flex justify-between items-center">
        <div class="font-bold uppercase text-lg" id="app-title">NH·∫¨T TR√åNH M√ÅY</div>
        <div class="text-xs bg-blue-800 px-2 py-1 rounded cursor-pointer" onclick="doLogout()">Tho√°t</div>
    </div>

    <div id="screen-input" class="screen active container mx-auto p-3 max-w-lg">
        <form id="reportForm" onsubmit="submitForm(event)">
            <div class="form-section">
                <div class="bg-blue-50 p-2 rounded mb-3 text-sm text-blue-800">
                    <i class="fas fa-user-check mr-1"></i> Xin ch√†o: <b id="user-fullname">...</b>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="date" id="ngayBaoCao" class="form-input" required>
                    <input type="tel" id="sdt" class="form-input" placeholder="SƒêT li√™n h·ªá" required>
                </div>
                
                <select id="tenCongTrinh" class="form-input font-semibold" required>
                    <option value="">-- Ch·ªçn c√¥ng tr√¨nh --</option>
                </select>

                <div class="flex gap-2 mb-3">
                    <select id="maThietBi" class="form-input flex-1" required>
                        <option value="">-- Ch·ªçn m√°y --</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <div class="font-bold text-blue-900 mb-2 border-b pb-1">Chi ti·∫øt c√¥ng vi·ªác</div>
                <div id="workTableBody"></div>
                <button type="button" onclick="addWorkRow()" class="text-xs bg-blue-100 text-blue-800 px-3 py-1 rounded-full mt-2">+ Th√™m d√≤ng</button>
            </div>
            
            <div class="form-section">
                <div class="font-bold text-blue-900 mb-2 border-b pb-1">Nhi√™n li·ªáu</div>
                <div id="fuelTableBody"></div>
                <button type="button" onclick="addFuelRow()" class="text-xs bg-blue-100 text-blue-800 px-3 py-1 rounded-full mt-2">+ Th√™m d√≤ng</button>
            </div>

            <div class="form-section border-l-4 border-red-500">
                <label class="block text-red-700 font-bold mb-1">S·ª≠a ch·ªØa & Ki·∫øn ngh·ªã</label>
                <textarea id="noiDungSua" class="form-input" rows="1" placeholder="H·ªèng h√≥c..."></textarea>
                <input type="number" id="chiPhiSua" class="form-input" placeholder="Chi ph√≠ (VNƒê)">
                <textarea id="kienNghi" class="form-input mt-2" rows="1" placeholder="ƒê·ªÅ xu·∫•t..."></textarea>
            </div>

            <button type="submit" class="btn-submit"><i class="fas fa-paper-plane mr-2"></i> G·ª¨I B√ÅO C√ÅO</button>
            <input type="hidden" id="nguoiBaoHidden"> 
        </form>
    </div>

    <div id="screen-stats" class="screen container mx-auto p-3 max-w-lg">
        <h3 class="font-bold text-gray-700 mb-3 uppercase">T·ªïng h·ª£p c·ªßa b·∫°n</h3>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="stat-card">
                <div class="text-sm text-gray-500">T·ªïng gi·ªù l√†m</div>
                <div class="stat-value" id="stat-hours">0</div>
                <div class="text-xs text-gray-400">T√≠ch l≈©y</div>
            </div>
            <div class="stat-card border-l-green-500">
                <div class="text-sm text-gray-500">T·ªïng Ca m√°y</div>
                <div class="stat-value text-green-600" id="stat-shifts">0</div>
                <div class="text-xs text-gray-400">T√≠ch l≈©y</div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4 mb-4">
            <h4 class="font-bold text-red-700 border-b pb-2 mb-2"><i class="fas fa-tools mr-2"></i>L·ªãch s·ª≠ H∆∞ h·ªèng/S·ª≠a ch·ªØa</h4>
            <div id="list-repairs" class="text-sm text-gray-600">ƒêang t·∫£i...</div>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
            <h4 class="font-bold text-yellow-600 border-b pb-2 mb-2"><i class="fas fa-lightbulb mr-2"></i>Ki·∫øn ngh·ªã ƒë√£ g·ª≠i</h4>
            <div id="list-petitions" class="text-sm text-gray-600">ƒêang t·∫£i...</div>
        </div>
        
        <button onclick="loadStats()" class="w-full mt-4 bg-gray-200 text-gray-600 py-2 rounded"><i class="fas fa-sync mr-2"></i>C·∫≠p nh·∫≠t s·ªë li·ªáu</button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchScreen('input', this)">
            <i class="fas fa-edit"></i> Nh·∫≠p li·ªáu
        </div>
        <div class="nav-item" onclick="switchScreen('stats', this)">
            <i class="fas fa-chart-pie"></i> T·ªïng qu√°t
        </div>
    </div>

    <script>
        // üëâ ANH D√ÅN LINK API M·ªöI V√ÄO ƒê√ÇY:
        const API_URL = "https://script.google.com/macros/s/AKfycbyl5PcdJUh7GjoX0m-SzADXDyX3wOXVRcrz6gkA2H_uCZ9XjnOPQ1lSf1eXd3JUxhGo/exec";
        
        // Bi·∫øn l∆∞u th√¥ng tin ng∆∞·ªùi d√πng
        let currentUser = null;

        // --- 1. X·ª¨ L√ù ƒêƒÇNG NH·∫¨P ---
        function doLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            if(!u || !p) return Swal.fire('L·ªói', 'Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin', 'warning');

            Swal.fire({title: 'ƒêang ki·ªÉm tra...', didOpen: () => Swal.showLoading()});

            fetch(API_URL + `?action=login&user=${u}&pass=${p}`)
            .then(r => r.json())
            .then(data => {
                Swal.close();
                if(data.status == 'success') {
                    currentUser = data;
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('user-fullname').innerText = data.hoTen;
                    document.getElementById('nguoiBaoHidden').value = data.hoTen;
                    document.getElementById('sdt').value = u; // T·ª± ƒëi·ªÅn SƒêT t·ª´ t√†i kho·∫£n
                    
                    // Kh·ªüi t·∫°o d·ªØ li·ªáu
                    document.getElementById('ngayBaoCao').valueAsDate = new Date();
                    fetchProjects(); fetchMachines(); addWorkRow(); addFuelRow();
                } else {
                    Swal.fire('Th·∫•t b·∫°i', data.message, 'error');
                }
            })
            .catch(e => Swal.fire('L·ªói m·∫°ng', e.toString(), 'error'));
        }

        function doLogout() {
            location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ ƒëƒÉng xu·∫•t
        }

        // --- 2. X·ª¨ L√ù CHUY·ªÇN TAB V√Ä T·∫¢I TH·ªêNG K√ä ---
        function switchScreen(screenName, navEl) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('screen-' + screenName).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');

            if(screenName == 'stats') loadStats();
        }

        function loadStats() {
            if(!currentUser) return;
            document.getElementById('list-repairs').innerText = 'ƒêang t·∫£i...';
            
            fetch(API_URL + `?action=getDriverStats&name=${encodeURIComponent(currentUser.hoTen)}`)
            .then(r => r.json())
            .then(data => {
                // Hi·ªÉn th·ªã s·ªë li·ªáu
                document.getElementById('stat-hours').innerText = data.tongGio + "h";
                document.getElementById('stat-shifts').innerText = data.tongCa;

                // Hi·ªÉn th·ªã list s·ª≠a ch·ªØa
                const repairDiv = document.getElementById('list-repairs');
                if(data.suaChua.length == 0) repairDiv.innerText = "Ch∆∞a c√≥ ghi nh·∫≠n n√†o.";
                else {
                    repairDiv.innerHTML = data.suaChua.map(i => `
                        <div class="history-item">
                            <div class="history-date">${i.ngay.substring(0,10)}</div>
                            <div>${i.noiDung}</div>
                        </div>`).join('');
                }

                // Hi·ªÉn th·ªã list ki·∫øn ngh·ªã
                const petitionDiv = document.getElementById('list-petitions');
                if(data.kienNghi.length == 0) petitionDiv.innerText = "Ch∆∞a c√≥ ki·∫øn ngh·ªã n√†o.";
                else {
                    petitionDiv.innerHTML = data.kienNghi.map(i => `
                        <div class="history-item">
                            <div class="history-date">${i.ngay.substring(0,10)}</div>
                            <div>${i.noiDung}</div>
                        </div>`).join('');
                }
            });
        }

        // --- 3. C√ÅC H√ÄM C≈® (INPUT FORM) GI·ªÆ NGUY√äN LOGIC ---
        // (T√¥i ƒë√£ r√∫t g·ªçn code ph·∫ßn n√†y ƒë·ªÉ t·∫≠p trung v√†o t√≠nh nƒÉng m·ªõi, nh∆∞ng ch·ª©c nƒÉng v·∫´n ƒë·∫ßy ƒë·ªß)
        async function fetchProjects() {
             const sel = document.getElementById('tenCongTrinh');
             try {
                 const res = await fetch(API_URL + "?action=getDanhSachCongTrinh");
                 const data = await res.json();
                 sel.innerHTML = '<option value="">-- Ch·ªçn c√¥ng tr√¨nh --</option>';
                 if(Array.isArray(data)) data.forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);
             } catch(e){}
        }
        async function fetchMachines() {
             const sel = document.getElementById('maThietBi');
             try {
                 const res = await fetch(API_URL + "?action=getDanhSachMay");
                 const data = await res.json();
                 sel.innerHTML = '<option value="">-- Ch·ªçn m√°y --</option>';
                 data.forEach(m => sel.innerHTML += `<option value="${m.maMay}">${m.tenMay} (${m.bienSo})</option>`);
             } catch(e){}
        }
        function addWorkRow() {
            document.getElementById('workTableBody').insertAdjacentHTML('beforeend', `
            <div class="flex gap-1 mb-2 items-center work-row">
                <select class="form-input w-1/4 w-shift font-bold p-1"><option>S√°ng</option><option>Chi·ªÅu</option><option>TƒÉng ca</option></select>
                <input class="form-input w-2/4 w-content p-1" placeholder="Vi·ªác...">
                <input type="number" class="form-input w-1/6 w-vol p-1 text-center" placeholder="SL">
                <select class="form-input w-1/6 w-unit p-1 text-xs"><option>Gi·ªù</option><option>Ca</option><option>m3</option><option>Chuy·∫øn</option></select>
            </div>`);
        }
        function addFuelRow() {
            document.getElementById('fuelTableBody').insertAdjacentHTML('beforeend', `
            <div class="flex gap-1 mb-2 items-center fuel-row">
                <select class="form-input w-1/2 f-type font-semibold"><option>Diesel</option><option>D·∫ßu c·∫ßu</option><option>D·∫ßu m√°y</option><option>Th·ªßy l·ª±c</option><option>M·ª°</option><option>Kh√°c</option></select>
                <input type="number" class="form-input w-1/3 f-vol p-1 text-center" placeholder="L√≠t/Kg">
                <i class="fas fa-times text-red-500 w-6 text-center" onclick="this.parentElement.remove()"></i>
            </div>`);
        }
        
        function submitForm(e) {
            e.preventDefault();
            Swal.fire({ title: 'ƒêang g·ª≠i...', didOpen: () => Swal.showLoading() });
            
            let works = [];
            document.querySelectorAll('.work-row').forEach(row => {
                let c = row.querySelector('.w-content').value;
                let v = row.querySelector('.w-vol').value;
                if(c || v) works.push({
                    caLam: row.querySelector('.w-shift').value,
                    noiDung: c || "Kƒê", khoiLuong: v||0, donVi: row.querySelector('.w-unit').value
                });
            });

            let fuel = {diesel:0, dauCau:0, dauMay:0, thuyLuc:0, khac:[]};
            document.querySelectorAll('.fuel-row').forEach(row => {
                let t = row.querySelector('.f-type').value;
                let v = parseFloat(row.querySelector('.f-vol').value) || 0;
                if(v>0) {
                    if(t=='Diesel') fuel.diesel+=v; else if(t=='D·∫ßu c·∫ßu') fuel.dauCau+=v;
                    else if(t=='D·∫ßu m√°y') fuel.dauMay+=v; else if(t=='Th·ªßy l·ª±c') fuel.thuyLuc+=v;
                    else fuel.khac.push(`${t}:${v}`);
                }
            });

            // T√≠nh t·ªïng string
            let totalStr = works.reduce((acc, curr) => {
                 // Logic c·ªông ƒë∆°n gi·∫£n
                 return acc; 
            }, "");
             // ƒê·ªÉ ƒë∆°n gi·∫£n, ph·∫ßn t√≠nh t·ªïng hi·ªÉn th·ªã t√¥i d√πng CSS ·ªü backend, frontend ch·ªâ g·ª≠i data th√¥
            let displayTotal = "Chi ti·∫øt trong Sheet"; 

            const data = {
                ngayBaoCao: document.getElementById('ngayBaoCao').value,
                tenCongTrinh: document.getElementById('tenCongTrinh').value,
                sdt: document.getElementById('sdt').value,
                maThietBi: document.getElementById('maThietBi').value,
                nguoiBao: currentUser.hoTen, // L·∫§Y T·ª™ USER ƒêƒÇNG NH·∫¨P
                danhSachViec: works,
                tongKhoiLuong: displayTotal,
                diesel: fuel.diesel, dauCau: fuel.dauCau, dauThuyLuc: fuel.thuyLuc, dauMay: fuel.dauMay, dauKhac: fuel.khac.join(','),
                noiDungSua: document.getElementById('noiDungSua').value,
                chiPhiSua: document.getElementById('chiPhiSua').value,
                kienNghi: document.getElementById('kienNghi').value
            };

            fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(data)})
            .then(() => {
                Swal.fire({icon:'success', title:'Th√†nh c√¥ng', timer:1500, showConfirmButton:false});
                document.getElementById('reportForm').reset();
                // Reset v·ªÅ m·∫∑c ƒë·ªãnh
                document.getElementById('workTableBody').innerHTML = ''; addWorkRow();
                document.getElementById('fuelTableBody').innerHTML = ''; addFuelRow();
                document.getElementById('ngayBaoCao').valueAsDate = new Date();
            });
        }
    </script>
</body>
</html>
